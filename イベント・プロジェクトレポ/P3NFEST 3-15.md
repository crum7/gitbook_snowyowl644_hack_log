
現地参加　in Abema Tower


# 脆弱性の探求：攻撃者の目線で校内ネットワークを探る, VulnHub - VulnUni
林 憲明氏（トレンドマイクロ サイバーセキュリティ・イノベーション研究所 プリンシパルエンジニア）

# ネットワーク調査と脆弱性分析メモ

## 初期調査

### ネットワーク偵察

- IPアドレス確認
- ターゲット検索用ping送信
    
    ```
    sudo nmap -Sn 172.16.208.0/24
    ```
    
- オクテットが大きいのは恐らく違う

### 設定

- `/etc/host`に設定
    
    ```
    <IP> vulnuni.local
    ```
    

## スキャンと情報収集

### nmapオプション（林さん使用）

```
nmap -Pn -T4 -A <Target IP>
```

### ターゲットサイト分析方法

- サイト全体のロジックを捉える
- 何のためのサイトか
- 目的から提供されているサービスとフレームワークを想像できる
- 大学のサイトはLMSとか使われてるんじゃないか
- どんなサービスを提供
- メニューからフレームワークを想像できるか
- ブログといえばWordPressでしょうとか
- ユーザーの入力の受け付け方
- どんな種類のデータが入力できるのか
- ファイルをアップロードすることはできるのか
- コンタクトフォーム > 複数のテキストボックスがある
- XSS/CSRFとか使えるんじゃないの？
- ユーザーリストの取得
- 横展開時にユーザーリストを使うこともできるよね
- スタッフに教員の名前が載ってるよね

## ツール

### ブラウザプラグイン

- いつものHTBのPwnBox以外で使ってるやつ
- Hacktools
- Pwnfox

### curl活用

```
curl -s http://<domain> | grep "<!--"
```

- vulnuni-eclass-platform.html

## 脆弱性調査手法

### 脆弱性を探す際のポイント

- バージョン検索時はメジャーバージョンくらいまでしか入れない

### CMSの脆弱性診断の方法論

1. CMSのベンダーとバージョンを特定
2. 特定バージョンに関する既知の脆弱性
3. コンポーネントの情報収集
    - バージョンとソフトはわかるのに、exploitが見つからない時は"GitHub"で探してみる
    - "GitHub"に書かれているPOCをそのまま使うのではなく、handcraftでexploitができないか作ってみるような使い方がいいのではないか
4. 活用フェーズ
5. 踏み台からの内部侵入拡張
    - 権限昇格とか

## SQL Injection

### 有名なSQLi

- Phrackという hacking メルマガに掲載

### 検出ツール

- Burp Suiteではなく、OWASP ZAPとかもある

### Blind SQL Injection

- ユーザー名を「admin」で試してみる
    
    ```
    uname=admin' AND sleep(5);-- -&pass=password&submit=Enter
    ```
    
- ユーザー名を「hacker」に変えてみる
- 返答時間は5秒ではなくて1秒くらい

### Time-based SQLi

- Blindを時間ベースで調べる
- 教科書的に言うとサイドチャネル攻撃だよね

### 存在しているadminユーザーでデータベース構造を表示する

```
admin' and (SELECT sleep(5) from dual where database() like 'a%');--
```

- Aから始まるデータベースはあるかを調査する

```
admin' and (SELECT sleep(5) from dual where database() like 'b%');--
```

- Bから始まるデータベースはあるのか

### SQLMapの活用

```
sqlmap -r ecalsslogin.raw
```

- POSTのログ?

### ポイント

- 見つかったデータベースの中でどこに「おいしい（juice）」な情報があるのか

```
sqlmap -r ecalsslogin.raw -v -D eclass --tables --batch
```

### ユーザー指定実行

```
sqlmap -r ecalsslogin.raw -v -D eclass -T user
```

（このあとはわからなかった）

## その他

### 確認項目

- カーネルバージョンの確認

### phpMyAdmin活用

- phpMyAdminにMySQLの認証情報でログインできる
- phpMyAdminにどんなクエリでも実行できるはず、右ファイルの書き込みができるのではないか
- なのでWebシェルを設置することができないだろうか

### 追加情報

- ルータなど、用途が限定的なLinuxが入ってるものでは、今だにDirtyCowなどは刺さるらしい
# コードから探す脆弱性
RyotaK氏（GMO Flatt Security　プロフェッショナルサービス事業部 / 研究開発事業部 セキュリティエンジニア）

## コードの読み方3選
### 1. ユーザー入力から探す
- HTTPのクエリからコードを下向きに読む
- 3つの中では網羅性がある
- ソース（入力）とシンク（影響を受ける箇所）を特定して脆弱性を探す

### 2. 脆弱になりやすい箇所から探す
- 変な値が入るとまずい箇所を特定し、そこから逆向きにコードを追う

### 3. テーマをもとに探す
- 例: **認証不備、XSSの刺さるポイント**
- 「こういう脆弱性が多いのでは？」という仮説を立て、網羅的に探索する

## ユーザー入力から探す
### クエリパラメーターを利用した攻撃の例
- クエリパラメーターから値を取得
- XSS対策がされているかチェック
- エラーメッセージにユーザー入力が含まれているか確認

### `innerHTML` によるXSSリスク
- `innerHTML` に変な入力が入ると問題が発生する
- `name` 変数はフィルタリングされているか確認
- もう一つの `innerHTML` が確認されていない可能性がある
- エラー内に `name` 変数が含まれる場合、フィルタリングが原因でエラーが発生する
- クエリパラメータから取得している場合、XSSペイロードが可能なケースがある

### エラーハンドラーの脆弱性
- **エラーハンドラー内でXSSができる可能性** を検討する

## リバースエンジニアリングでコードを読む

### WEBフロントエンド
- **大きく分けて2つの方法**
  1. ブラウザに配信されたコードをそのまま読む
  2. ソースマップが配信され、難読化を解除して読む（`//# sourceMappingURL=` をチェック）
- 両方とも **Chrome DevTools** で確認可能

### DevTools でコードを読む
1. **ソースタブ** から対象のファイルを選択
2. **左下の「フォーマット」ボタン** を押すと読みやすくなる

### 難読化コードの対処
- `//# sourceMappingURL=` を確認し、どのように難読化されているかを把握する

### Chrome などの拡張機能
- 拡張機能をインストールするとローカルにファイルが保存される
- そのファイルを直接確認することでコードを読むことができる

## Java製のアプリケーションの解析
- Javaは **中間言語** で配布される
- **逆コンパイルツール**
  - `VinfFlower`
  - `JADX`（おすすめ）

## .NETアプリケーションの解析
- .NETアプリも **中間言語で配布** される
- 逆コンパイルツールを使用するとコードを復元可能

## 簡単なリバースエンジニアリング
- **ツールに放り込むだけで意外とコードに直せる** ことが多い

## パッチ解析を通じた脆弱性解析
- **修正前のバージョンと修正済みのバージョンの差分を確認**
- 脆弱性の修正が行われたコミットを読むことで問題点を発見できる

## 学習ロードマップ
1. **開発を経験する**
2. **パッチ解析を継続する**（見つかるまでやる）
3. **自分で脆弱性を探す**
4. **脆弱性を見つけられるようになる**